<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Matematiƒçka Igrica</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // JsonBin Configuration
        const JSONBIN_CONFIG = {
            apiKey: '$2a$10$31RITG3SmDIKuboB6WgUdurK6MSbN1lxd7wpIZWNq.TVm8JkRvHi.',
            binId: '68bf0f7ad0ea881f40764962',
            baseUrl: 'https://api.jsonbin.io/v3'
        };

        // Icons
        const Star = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" />
            </svg>
        );

        const Trophy = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
                <path d="M4 22h16" />
                <path d="M10 14.66V17c0 .55.47.98.97 1.21C12.04 18.75 13 20.24 13 22" />
                <path d="M14 14.66V17c0 .55-.47.98-.97 1.21C11.96 18.75 11 20.24 11 22" />
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
            </svg>
        );

        const Clock = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10" />
                <polyline points="12,6 12,12 16,14" />
            </svg>
        );

        const Heart = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z" />
            </svg>
        );

        const User = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                <circle cx="12" cy="7" r="4" />
            </svg>
        );

        const Download = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="7,10 12,15 17,10" />
                <line x1="12" y1="15" x2="12" y2="3" />
            </svg>
        );

        const Cloud = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10Z" />
            </svg>
        );

        const Wifi = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M5 13a10 10 0 0 1 14 0" />
                <path d="M8.5 16.5a5 5 0 0 1 7 0" />
                <path d="M12 20h.01" />
            </svg>
        );

        const WifiOff = ({ className = "", size = 24, ...props }) => (
            <svg {...props} className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M1 1l22 22" />
                <path d="M8.5 16.5a5 5 0 0 1 7 0" />
                <path d="M12 20h.01" />
                <path d="M2 8.82a15 15 0 0 1 4.17-2.65" />
                <path d="M10.66 5c4.01-.36 8.14.9 11.34 3.76" />
                <path d="M16.85 11.25a10 10 0 0 1 2.22 1.68" />
            </svg>
        );

        // Level definitions
        const LEVELS = [
            { id: 1, name: "Poƒçetnik", emoji: "üå±", operations: ['+', '-'], maxNum: 20, questionsNeeded: 10, timeLimit: 20 },
            { id: 2, name: "Istra≈æivaƒç", emoji: "üîç", operations: ['+', '-'], maxNum: 50, questionsNeeded: 15, timeLimit: 18 },
            { id: 3, name: "Uƒçenik", emoji: "üìö", operations: ['+', '-', '√ó'], maxNum: 100, questionsNeeded: 20, timeLimit: 16 },
            { id: 4, name: "Matematiƒçar", emoji: "üßÆ", operations: ['+', '-', '√ó', '√∑'], maxNum: 144, questionsNeeded: 25, timeLimit: 15 },
            { id: 5, name: "Struƒçnjak", emoji: "üéì", operations: ['+', '-', '√ó', '√∑'], maxNum: 200, questionsNeeded: 30, timeLimit: 14 },
            { id: 6, name: "Majstor", emoji: "üëë", operations: ['+', '-', '√ó', '√∑'], maxNum: 500, questionsNeeded: 35, timeLimit: 13 },
            { id: 7, name: "Genij", emoji: "üß†", operations: ['+', '-', '√ó', '√∑'], maxNum: 1000, questionsNeeded: 40, timeLimit: 12 }
        ];

        const MathGame = () => {
            // All state variables
            const [gameState, setGameState] = useState('welcome');
            const [playerName, setPlayerName] = useState('');
            const [currentQuestion, setCurrentQuestion] = useState('');
            const [answer, setAnswer] = useState('');
            const [correctAnswer, setCorrectAnswer] = useState(0);
            const [score, setScore] = useState(0);
            const [timeLeft, setTimeLeft] = useState(20);
            const [lives, setLives] = useState(3);
            const [currentLevel, setCurrentLevel] = useState(1);
            const [questionsInLevel, setQuestionsInLevel] = useState(0);
            const [streak, setStreak] = useState(0);
            const [showFeedback, setShowFeedback] = useState('');
            const [sessionStats, setSessionStats] = useState({ correct: 0, wrong: 0, timeouts: 0 });
            const [isOnline, setIsOnline] = useState(true);
            const [isLoading, setIsLoading] = useState(false);

            // Cloud data
            const [cloudData, setCloudData] = useState({ players: {}, lastUpdate: null });
            const [localData, setLocalData] = useState(() => {
                const saved = localStorage.getItem('mathGamePlayers');
                return saved ? JSON.parse(saved) : {};
            });

            // JsonBin functions
            const isJsonBinConfigured = () => {
                return JSONBIN_CONFIG.apiKey !== '$2a$10$Q3Z8Q3Z8Q3Z8Q3Z8Q3Z8Qu' && 
                       JSONBIN_CONFIG.binId !== 'your-bin-id';
            };

            const loadFromCloud = async () => {
                if (!isJsonBinConfigured()) {
                    console.log('JsonBin nije konfiguriran, koristimo lokalne podatke');
                    return;
                }

                setIsLoading(true);
                try {
                    const response = await fetch(`${JSONBIN_CONFIG.baseUrl}/b/${JSONBIN_CONFIG.binId}/latest`, {
                        method: 'GET',
                        headers: {
                            'X-Master-Key': JSONBIN_CONFIG.apiKey,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        setCloudData(data.record || { players: {}, lastUpdate: null });
                        setIsOnline(true);
                        console.log('Podaci uƒçitani iz oblaka');
                    } else {
                        throw new Error('Gre≈°ka pri dohvaƒáanju podataka');
                    }
                } catch (error) {
                    console.error('Gre≈°ka pri dohvaƒáanju iz oblaka:', error);
                    setIsOnline(false);
                } finally {
                    setIsLoading(false);
                }
            };

            const saveToCloud = async (newData) => {
                if (!isJsonBinConfigured()) {
                    console.log('JsonBin nije konfiguriran, spremamo lokalno');
                    return false;
                }

                try {
                    const dataToSave = {
                        players: newData,
                        lastUpdate: new Date().toISOString()
                    };

                    const response = await fetch(`${JSONBIN_CONFIG.baseUrl}/b/${JSONBIN_CONFIG.binId}`, {
                        method: 'PUT',
                        headers: {
                            'X-Master-Key': JSONBIN_CONFIG.apiKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(dataToSave)
                    });

                    if (response.ok) {
                        setCloudData(dataToSave);
                        setIsOnline(true);
                        console.log('Podaci spremljeni u oblak');
                        return true;
                    } else {
                        throw new Error('Gre≈°ka pri spremanju');
                    }
                } catch (error) {
                    console.error('Gre≈°ka pri spremanju u oblak:', error);
                    setIsOnline(false);
                    return false;
                }
            };

            // Game functions
            const getCurrentLevelData = () => LEVELS.find(l => l.id === currentLevel);

            const generateQuestion = () => {
                const levelData = getCurrentLevelData();
                let operations = [...levelData.operations];
                let operation;

                // Use weights for higher levels to favor multiplication/division
                if (levelData.multiplyWeight && Math.random() < levelData.multiplyWeight) {
                    // Focus on multiplication and division
                    const multiplyOps = operations.filter(op => op === '√ó' || op === '√∑');
                    if (multiplyOps.length > 0) {
                        operation = multiplyOps[Math.floor(Math.random() * multiplyOps.length)];
                    } else {
                        operation = operations[Math.floor(Math.random() * operations.length)];
                    }
                } else {
                    operation = operations[Math.floor(Math.random() * operations.length)];
                }

                let num1, num2, result, question;

                switch (operation) {
                    case '+':
                        if (levelData.id <= 2) {
                            num1 = Math.floor(Math.random() * levelData.maxNum) + 1;
                            num2 = Math.floor(Math.random() * levelData.maxNum) + 1;
                        } else {
                            // Higher levels: smaller addition problems
                            num1 = Math.floor(Math.random() * 30) + 1;
                            num2 = Math.floor(Math.random() * 30) + 1;
                        }
                        result = num1 + num2;
                        question = `${num1} + ${num2}`;
                        break;
                        
                    case '-':
                        if (levelData.id <= 2) {
                            num1 = Math.floor(Math.random() * levelData.maxNum) + 10;
                            num2 = Math.floor(Math.random() * num1) + 1;
                        } else {
                            // Higher levels: smaller subtraction problems
                            num1 = Math.floor(Math.random() * 50) + 20;
                            num2 = Math.floor(Math.random() * (num1 - 10)) + 1;
                        }
                        result = num1 - num2;
                        question = `${num1} - ${num2}`;
                        break;
                        
                    case '√ó':
                        // Always use multiplication table up to 10√ó10
                        num1 = Math.floor(Math.random() * 10) + 1;
                        num2 = Math.floor(Math.random() * 10) + 1;
                        result = num1 * num2;
                        question = `${num1} √ó ${num2}`;
                        break;
                        
                    case '√∑':
                        // Always use division table up to 10√ó10 (reverse of multiplication)
                        num2 = Math.floor(Math.random() * 10) + 1;
                        result = Math.floor(Math.random() * 10) + 1;
                        num1 = num2 * result;
                        question = `${num1} √∑ ${num2}`;
                        break;
                }

                setCurrentQuestion(question);
                setCorrectAnswer(result);
                setTimeLeft(levelData.timeLimit);
            };

            const startGame = () => {
                setGameState('playing');
                setScore(0);
                setLives(3);
                setCurrentLevel(1);
                setQuestionsInLevel(0);
                setStreak(0);
                setAnswer('');
                setShowFeedback('');
                setSessionStats({ correct: 0, wrong: 0, timeouts: 0 });
                generateQuestion();
            };

            const nextLevel = () => {
                setAnswer('');
                setShowFeedback('');
                setCurrentLevel(currentLevel + 1);
                setQuestionsInLevel(0);
                setLives(3);
                setGameState('playing');
                setTimeout(() => {
                    generateQuestion();
                }, 100);
            };

            const checkAnswer = () => {
                const userAnswer = parseInt(answer);
                const levelData = getCurrentLevelData();
                
                if (userAnswer === correctAnswer) {
                    const timeBonus = timeLeft * 2;
                    const streakBonus = streak * 5;
                    const levelBonus = currentLevel * 10;
                    const points = 20 + timeBonus + streakBonus + levelBonus;
                    
                    setScore(score + points);
                    setStreak(streak + 1);
                    setQuestionsInLevel(questionsInLevel + 1);
                    setSessionStats(prev => ({ ...prev, correct: prev.correct + 1 }));
                    setShowFeedback('correct');
                    
                    if (questionsInLevel + 1 >= levelData.questionsNeeded) {
                        setTimeout(() => {
                            setAnswer('');
                            setShowFeedback('');
                            if (currentLevel < LEVELS.length) {
                                setGameState('levelComplete');
                            } else {
                                endGame();
                            }
                        }, 1000);
                        return;
                    }
                    
                    setTimeout(() => {
                        setShowFeedback('');
                        setAnswer('');
                        generateQuestion();
                    }, 1500);
                } else {
                    setLives(lives - 1);
                    setStreak(0);
                    setSessionStats(prev => ({ ...prev, wrong: prev.wrong + 1 }));
                    setShowFeedback('wrong');
                    
                    setTimeout(() => {
                        setShowFeedback('');
                        if (lives - 1 <= 0) {
                            endGame();
                        } else {
                            setAnswer('');
                            generateQuestion();
                        }
                    }, 1500);
                }
            };

            const handleTimeout = () => {
                setLives(lives - 1);
                setStreak(0);
                setSessionStats(prev => ({ ...prev, timeouts: prev.timeouts + 1 }));
                setShowFeedback('timeout');
                setTimeout(() => {
                    setShowFeedback('');
                    if (lives - 1 <= 0) {
                        endGame();
                    } else {
                        setAnswer('');
                        generateQuestion();
                    }
                }, 1500);
            };

            const endGame = async () => {
                setGameState('gameOver');
                
                const newResult = {
                    date: new Date().toLocaleDateString('hr-HR'),
                    time: new Date().toLocaleTimeString('hr-HR'),
                    score: score,
                    level: currentLevel,
                    stats: sessionStats
                };

                const allPlayers = getAllPlayers();
                const updatedPlayerData = {
                    ...allPlayers,
                    [playerName]: {
                        name: playerName,
                        bestScore: Math.max(score, allPlayers[playerName]?.bestScore || 0),
                        maxLevel: Math.max(currentLevel, allPlayers[playerName]?.maxLevel || 1),
                        gamesPlayed: (allPlayers[playerName]?.gamesPlayed || 0) + 1,
                        results: [...(allPlayers[playerName]?.results || []), newResult].slice(-10)
                    }
                };

                setLocalData(updatedPlayerData);

                if (isJsonBinConfigured()) {
                    await saveToCloud(updatedPlayerData);
                }
            };

            const getAllPlayers = () => {
                const merged = { ...localData };
                
                if (isJsonBinConfigured() && cloudData.players) {
                    Object.keys(cloudData.players).forEach(playerName => {
                        const cloudPlayer = cloudData.players[playerName];
                        const localPlayer = merged[playerName];
                        
                        if (!localPlayer || cloudPlayer.bestScore > localPlayer.bestScore) {
                            merged[playerName] = cloudPlayer;
                        }
                    });
                }
                
                return merged;
            };

            const getTopPlayers = () => {
                const allPlayers = getAllPlayers();
                return Object.values(allPlayers)
                    .sort((a, b) => b.bestScore - a.bestScore)
                    .slice(0, 10);
            };

            const getLevelProgress = () => {
                const levelData = getCurrentLevelData();
                return Math.min((questionsInLevel / levelData.questionsNeeded) * 100, 100);
            };

            const exportResults = () => {
                const allPlayers = getAllPlayers();
                const data = JSON.stringify(allPlayers, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `matematicka-igrica-rezultati-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
            };

            const refreshCloudData = async () => {
                await loadFromCloud();
            };

            // Effects
            useEffect(() => {
                loadFromCloud();
            }, []);

            useEffect(() => {
                localStorage.setItem('mathGamePlayers', JSON.stringify(localData));
            }, [localData]);

            useEffect(() => {
                if (gameState === 'playing' && timeLeft > 0) {
                    const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (timeLeft === 0 && gameState === 'playing') {
                    handleTimeout();
                }
            }, [timeLeft, gameState]);

            // Focus input when question changes
            useEffect(() => {
                if (gameState === 'playing' && currentQuestion && !showFeedback) {
                    const timer = setTimeout(() => {
                        const input = document.querySelector('input[type="number"]');
                        if (input) {
                            input.focus();
                        }
                    }, 300);
                    return () => clearTimeout(timer);
                }
            }, [currentQuestion, questionsInLevel, currentLevel, gameState]);

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-400 via-pink-400 to-yellow-400 flex items-center justify-center p-4">
                    <div className="bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md">
                        
                        {/* Cloud Status */}
                        {isJsonBinConfigured() && (
                            <div className="flex items-center justify-between mb-4 p-2 bg-gray-50 rounded-lg text-sm">
                                <div className="flex items-center gap-2">
                                    {isOnline ? (
                                        <>
                                            <Wifi className="text-green-500" size={16} />
                                            <span className="text-green-700">Online natjecanje</span>
                                        </>
                                    ) : (
                                        <>
                                            <WifiOff className="text-orange-500" size={16} />
                                            <span className="text-orange-700">Offline naƒçin</span>
                                        </>
                                    )}
                                </div>
                                {isLoading && <div className="text-blue-500">üîÑ</div>}
                            </div>
                        )}

                        {!isJsonBinConfigured() && (
                            <div className="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg text-sm">
                                <div className="flex items-center gap-2 text-yellow-800">
                                    <Cloud size={16} />
                                    <span>Lokalni naƒçin - podaci se spremaju samo na ovom ureƒëaju</span>
                                </div>
                            </div>
                        )}

                        {/* Welcome Screen */}
                        {gameState === 'welcome' && (
                            <div className="text-center">
                                <div className="mb-6">
                                    <h1 className="text-4xl font-bold text-purple-600 mb-2">üßÆ Matematiƒçka Igrica v2.0</h1>
                                    <p className="text-gray-600">
                                        {isJsonBinConfigured() ? 'Dobrodo≈°li u online natjecanje!' : 'Dobrodo≈°li u svijet brojeva!'}
                                    </p>
                                </div>
                                
                                <div className="mb-6">
                                    <User className="mx-auto text-purple-500 mb-4" size={48} />
                                    <label className="block text-lg font-bold text-gray-700 mb-2">
                                        Unesite svoje ime i prezime:
                                    </label>
                                    <input
                                        type="text"
                                        value={playerName}
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        className="w-full p-3 border-2 border-purple-300 rounded-xl focus:border-purple-500 focus:outline-none text-center text-lg"
                                        placeholder="Ana Aniƒá"
                                        onKeyPress={(e) => e.key === 'Enter' && playerName.trim() && setGameState('menu')}
                                    />
                                </div>
                                
                                <button 
                                    onClick={() => playerName.trim() && setGameState('menu')}
                                    disabled={!playerName.trim()}
                                    className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 px-8 rounded-full text-xl hover:scale-105 transform transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    Nastavi üöÄ
                                </button>
                            </div>
                        )}

                        {/* Main Menu */}
                        {gameState === 'menu' && (
                            <div className="text-center">
                                <div className="mb-6">
                                    <h2 className="text-3xl font-bold text-purple-600 mb-2">
                                        Pozdrav, {playerName}! üëã
                                    </h2>
                                    <p className="text-gray-600">≈†to ≈æelite raditi?</p>
                                </div>

                                {(() => {
                                    const allPlayers = getAllPlayers();
                                    const player = allPlayers[playerName];
                                    if (player) {
                                        return (
                                            <div className="bg-blue-100 rounded-xl p-4 mb-6">
                                                <div className="text-sm text-blue-800 mb-2">
                                                    üèÜ Najbolji rezultat: <strong>{player.bestScore}</strong>
                                                </div>
                                                <div className="text-sm text-blue-800 mb-2">
                                                    üìä Maksimalni nivo: <strong>{player.maxLevel}</strong>
                                                </div>
                                                <div className="text-sm text-blue-800">
                                                    üéÆ Odigrano igara: <strong>{player.gamesPlayed}</strong>
                                                </div>
                                            </div>
                                        );
                                    }
                                    return null;
                                })()}

                                <div className="space-y-4">
                                    <button 
                                        onClick={startGame}
                                        className="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-4 px-8 rounded-xl text-xl hover:scale-105 transform transition-all duration-200"
                                    >
                                        üéÆ Nova igra
                                    </button>
                                    
                                    <button 
                                        onClick={() => setGameState('leaderboard')}
                                        className="w-full bg-gradient-to-r from-yellow-400 to-orange-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                    >
                                        üèÜ {isJsonBinConfigured() ? 'Online ljestvica' : 'Najbolji igraƒçi'}
                                    </button>

                                    <button 
                                        onClick={() => setGameState('welcome')}
                                        className="w-full bg-gray-400 text-white font-bold py-3 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                    >
                                        üë§ Promijeni ime
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Achievements Screen */}
                        {gameState === 'achievements' && (
                            <div className="text-center">
                                <div className="mb-6">
                                    <h2 className="text-3xl font-bold text-purple-600 mb-4">Postignuƒáa</h2>
                                    <p className="text-gray-600">Va≈°i uspjesi u uƒçenju matematike</p>
                                </div>

                                {(() => {
                                    const playerData = getCurrentPlayerData();
                                    const playerAchievements = playerData.achievements || [];
                                    
                                    return (
                                        <div className="mb-6 max-h-80 overflow-y-auto space-y-3">
                                            {ACHIEVEMENTS.map((achievement, index) => {
                                                const isUnlocked = playerAchievements.includes(achievement.id);
                                                return (
                                                    <div key={index} className={`p-4 rounded-xl border-2 ${
                                                        isUnlocked 
                                                            ? 'bg-green-100 border-green-400' 
                                                            : 'bg-gray-100 border-gray-300 opacity-60'
                                                    }`}>
                                                        <div className="flex items-center gap-4">
                                                            <div className="text-3xl">
                                                                {isUnlocked ? achievement.emoji : 'üîí'}
                                                            </div>
                                                            <div className="flex-1 text-left">
                                                                <div className={`font-bold ${
                                                                    isUnlocked ? 'text-green-800' : 'text-gray-600'
                                                                }`}>
                                                                    {achievement.name}
                                                                </div>
                                                                <div className={`text-sm ${
                                                                    isUnlocked ? 'text-green-700' : 'text-gray-500'
                                                                }`}>
                                                                    {achievement.desc}
                                                                </div>
                                                            </div>
                                                            {isUnlocked && (
                                                                <div className="text-green-600 font-bold">
                                                                    ‚úì
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    );
                                })()}

                                <div className="bg-blue-100 rounded-xl p-4 mb-6">
                                    <div className="text-lg font-bold text-blue-800 mb-2">
                                        Napredak: {(() => {
                                            const playerData = getCurrentPlayerData();
                                            const unlockedCount = (playerData.achievements || []).length;
                                            return `${unlockedCount}/${ACHIEVEMENTS.length}`;
                                        })()} postignuƒáa
                                    </div>
                                    <div className="w-full bg-blue-200 rounded-full h-3">
                                        <div 
                                            className="bg-blue-600 h-3 rounded-full transition-all duration-500"
                                            style={{ 
                                                width: `${(() => {
                                                    const playerData = getCurrentPlayerData();
                                                    const unlockedCount = (playerData.achievements || []).length;
                                                    return (unlockedCount / ACHIEVEMENTS.length) * 100;
                                                })()}%` 
                                            }}
                                        ></div>
                                    </div>
                                </div>

                                <button 
                                    onClick={() => setGameState('menu')}
                                    className="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                >
                                    Povratak
                                </button>
                            </div>
                        )}

                        {/* Game Screen */}
                        {gameState === 'playing' && (
                            <div className="text-center">
                                <div className="flex justify-between items-center mb-4">
                                    <div className="flex gap-1">
                                        {[...Array(3)].map((_, i) => (
                                            <Heart 
                                                key={i} 
                                                className={`w-5 h-5 ${i < lives ? 'text-red-500 fill-current' : 'text-gray-300'}`} 
                                            />
                                        ))}
                                    </div>
                                    <div className="text-lg font-bold text-purple-600">
                                        {score} üåü
                                    </div>
                                </div>

                                <div className="mb-4">
                                    <div className="flex items-center justify-center gap-2 mb-2">
                                        <span className="text-2xl">{getCurrentLevelData().emoji}</span>
                                        <span className="font-bold text-lg text-purple-700">
                                            Nivo {currentLevel}: {getCurrentLevelData().name}
                                        </span>
                                    </div>
                                    
                                    <div className="w-full bg-gray-200 rounded-full h-3 mb-2">
                                        <div 
                                            className="bg-gradient-to-r from-green-400 to-blue-500 h-3 rounded-full transition-all duration-500"
                                            style={{ width: `${getLevelProgress()}%` }}
                                        ></div>
                                    </div>
                                    <div className="text-sm text-gray-600">
                                        {questionsInLevel}/{getCurrentLevelData().questionsNeeded} zadataka
                                    </div>
                                </div>

                                <div className="flex justify-between items-center mb-6">
                                    <div className="flex items-center gap-2">
                                        <Clock className="text-blue-500" size={18} />
                                        <span className={`text-lg font-bold ${timeLeft <= 5 ? 'text-red-500' : 'text-blue-500'}`}>
                                            {timeLeft}s
                                        </span>
                                    </div>
                                    {streak > 0 && (
                                        <span className="bg-orange-100 text-orange-800 px-3 py-1 rounded-full text-sm font-bold">
                                            üî• {streak}
                                        </span>
                                    )}
                                </div>

                                <div className="mb-6">
                                    <div className="text-3xl font-bold text-gray-800 mb-4 p-6 bg-gray-50 rounded-xl">
                                        {currentQuestion} = ?
                                    </div>
                                </div>

                                {showFeedback && (
                                    <div className={`mb-4 p-4 rounded-xl font-bold text-lg ${
                                        showFeedback === 'correct' ? 'bg-green-100 text-green-800' :
                                        showFeedback === 'wrong' ? 'bg-red-100 text-red-800' :
                                        'bg-orange-100 text-orange-800'
                                    }`}>
                                        {showFeedback === 'correct' && 'üéâ Odliƒçno!'}
                                        {showFeedback === 'wrong' && `‚ùå Odgovor je ${correctAnswer}`}
                                        {showFeedback === 'timeout' && '‚è∞ Vrijeme je isteklo!'}
                                    </div>
                                )}

                                <div className="mb-6">
                                    <input
                                        key={`level-${currentLevel}-q-${questionsInLevel}`}
                                        type="number"
                                        value={answer}
                                        onChange={(e) => setAnswer(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && answer && checkAnswer()}
                                        className="w-full text-2xl text-center p-4 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                                        placeholder="Va≈° odgovor..."
                                        disabled={showFeedback !== ''}
                                        autoFocus
                                    />
                                </div>

                                <button 
                                    onClick={checkAnswer}
                                    disabled={!answer || showFeedback !== ''}
                                    className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white font-bold py-4 px-6 rounded-xl text-xl hover:scale-105 transform transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
                                >
                                    ‚úì Potvrdi
                                </button>
                            </div>
                        )}

                        {/* Level Complete */}
                        {gameState === 'levelComplete' && (
                            <div className="text-center">
                                <div className="mb-6">
                                    <div className="text-6xl mb-4">üéâ</div>
                                    <h2 className="text-3xl font-bold text-purple-600 mb-2">
                                        Nivo zavr≈°en!
                                    </h2>
                                    <p className="text-lg text-gray-600 mb-4">
                                        Uspje≈°no ste zavr≈°ili <strong>Nivo {currentLevel}</strong>!
                                    </p>
                                    
                                    <div className="bg-green-100 rounded-xl p-6 mb-6">
                                        <div className="text-lg font-bold text-green-800 mb-2">
                                            Va≈° rezultat: {score} üåü
                                        </div>
                                        <div className="text-sm text-green-700">
                                            Toƒçni odgovori: {sessionStats.correct} ‚úÖ<br/>
                                            Niz: {streak} üî•
                                        </div>
                                    </div>

                                    {currentLevel < LEVELS.length && (
                                        <div className="bg-blue-100 rounded-xl p-4 mb-6">
                                            <div className="text-lg font-bold text-blue-800 mb-2">
                                                Sljedeƒái nivo: {LEVELS[currentLevel].emoji} {LEVELS[currentLevel].name}
                                            </div>
                                            <div className="text-sm text-blue-700">
                                                Potrebno: {LEVELS[currentLevel].questionsNeeded} zadataka<br/>
                                                Vrijeme: {LEVELS[currentLevel].timeLimit}s po zadatku
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="space-y-3">
                                    {currentLevel < LEVELS.length ? (
                                        <button 
                                            onClick={nextLevel}
                                            className="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-4 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                        >
                                            üöÄ Sljedeƒái nivo
                                        </button>
                                    ) : (
                                        <div className="bg-yellow-100 rounded-xl p-6">
                                            <div className="text-2xl font-bold text-yellow-800 mb-2">
                                                üèÜ ƒåestitamo! üèÜ
                                            </div>
                                            <div className="text-sm text-yellow-700">
                                                Zavr≈°ili ste sve nivoe!
                                            </div>
                                        </div>
                                    )}
                                    
                                    <button 
                                        onClick={() => setGameState('menu')}
                                        className="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                    >
                                        üè† Glavni meni
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Game Over */}
                        {gameState === 'gameOver' && (
                            <div className="text-center">
                                <div className="mb-6">
                                    <h2 className="text-3xl font-bold text-purple-600 mb-4">üéÆ Igra zavr≈°ena!</h2>
                                    <div className="bg-purple-100 rounded-xl p-6 mb-4">
                                        <div className="text-2xl font-bold text-purple-800 mb-2">
                                            Rezultat: {score} üåü
                                        </div>
                                        <div className="text-lg text-purple-700 mb-2">
                                            Dostignuti nivo: {currentLevel}
                                        </div>
                                        <div className="text-sm text-purple-600">
                                            ‚úÖ Toƒçno: {sessionStats.correct} | ‚ùå Netoƒçno: {sessionStats.wrong} | ‚è∞ Timeout: {sessionStats.timeouts}
                                        </div>
                                        {isJsonBinConfigured() && isOnline && (
                                            <div className="text-xs text-green-600 mt-2">
                                                ‚òÅÔ∏è Rezultat spremljen u oblak
                                            </div>
                                        )}
                                    </div>
                                </div>

                                <div className="space-y-3">
                                    <button 
                                        onClick={startGame}
                                        className="w-full bg-gradient-to-r from-green-400 to-blue-500 text-white font-bold py-4 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                    >
                                        üîÑ Nova igra
                                    </button>
                                    <button 
                                        onClick={() => setGameState('menu')}
                                        className="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                    >
                                        üè† Glavni meni
                                    </button>
                                </div>
                            </div>
                        )}

                        {/* Leaderboard */}
                        {gameState === 'leaderboard' && (
                            <div className="text-center">
                                <div className="mb-6">
                                    <div className="flex items-center justify-center gap-2 mb-4">
                                        <h2 className="text-3xl font-bold text-purple-600">üèÜ</h2>
                                        <h2 className="text-3xl font-bold text-purple-600">
                                            {isJsonBinConfigured() ? 'Online ljestvica' : 'Najbolji igraƒçi'}
                                        </h2>
                                    </div>
                                    {isJsonBinConfigured() && (
                                        <div className="flex items-center justify-center gap-2 mb-4">
                                            <button 
                                                onClick={refreshCloudData}
                                                disabled={isLoading}
                                                className="text-blue-500 hover:text-blue-700 flex items-center gap-1"
                                            >
                                                {isLoading ? 'üîÑ' : 'üîÑ'} Osvje≈æi
                                            </button>
                                            {cloudData.lastUpdate && (
                                                <span className="text-xs text-gray-500">
                                                    Zadnje a≈æuriranje: {new Date(cloudData.lastUpdate).toLocaleString('hr-HR')}
                                                </span>
                                            )}
                                        </div>
                                    )}
                                </div>

                                <div className="mb-6 max-h-96 overflow-y-auto">
                                    {getTopPlayers().length > 0 ? (
                                        getTopPlayers().map((player, index) => (
                                            <div key={index} className={`p-3 rounded-xl mb-2 ${
                                                index === 0 ? 'bg-yellow-100 border-2 border-yellow-400' :
                                                index === 1 ? 'bg-gray-100 border-2 border-gray-400' :
                                                index === 2 ? 'bg-orange-100 border-2 border-orange-400' :
                                                'bg-blue-50'
                                            }`}>
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xl">
                                                            {index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : `${index + 1}.`}
                                                        </span>
                                                        <span className={`font-bold ${player.name === playerName ? 'text-purple-600' : ''}`}>
                                                            {player.name}
                                                            {player.name === playerName && ' (Vi)'}
                                                        </span>
                                                    </div>
                                                    <div className="text-right">
                                                        <div className="font-bold text-purple-600">{player.bestScore} üåü</div>
                                                        <div className="text-xs text-gray-600">
                                                            Nivo {player.maxLevel} ‚Ä¢ {player.gamesPlayed} igara
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        ))
                                    ) : (
                                        <div className="text-gray-500">Nema jo≈° zabilje≈æenih rezultata</div>
                                    )}
                                </div>

                                <div className="space-y-3">
                                    <button 
                                        onClick={exportResults}
                                        disabled={getTopPlayers().length === 0}
                                        className="w-full bg-green-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Download size={20} />
                                        Izvezi rezultate
                                    </button>
                                    <button 
                                        onClick={() => setGameState('menu')}
                                        className="w-full bg-gray-500 text-white font-bold py-3 px-6 rounded-xl text-lg hover:scale-105 transform transition-all duration-200"
                                    >
                                        üè† Povratak
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        ReactDOM.render(<MathGame />, document.getElementById('root'));
    </script>
</body>
</html>
